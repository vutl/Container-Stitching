Container side-face stitching pipeline

Overview
--------
This repository contains the image-processing pipeline to detect, trim, align, rectify and stitch photographs of container side faces into panoramas. The goal is reliable, straight panoramas of container sides suitable for visual inspection or downstream analysis.

High-level stages
-----------------
1. Detection & corner estimation
   - Scripts: `test.py`, `test_sides.py` (side-specific variants)
   - Purpose: detect container faces and estimate bounding corners. Outputs corner text files per image.

2. (Optional) Trimming / corner updates
   - Scripts: `trim_black_sides_update_corners.py`, `trim_lr_black_update_corners.py`, `crop_unpad40_update_corners.py`
   - Purpose: remove border black areas, update corner coordinates to the trimmed images.

3. Alignment / warp to common canvas
   - Scripts: `warp_align.py`, `warp_align_sides.py`
   - Purpose: perspective-warp each side image using its four corners to a uniform canvas size. Options include centering the container horizontally (--center-container).

4. Rectify to rectangle
   - Scripts: `rectify_to_rectangle.py`, `rectify_to_rectangle_sides.py`
   - Purpose: produce axis-aligned rectified versions and masks for masked stitching.

5. Matching & stitching
   - Scripts: `sift_match_pairs.py`, `sift_match_pairs_sides.py`, `test3.py`, `test3_sides.py`
   - Purpose: estimate transforms between frames (translation, affine, homography) using feature matching and incremental stitching. Blending options include feathering and seam-cut.`

Folder layout (important source folders)
----------------------------------------
- `.` (repo root): main analysis & helper scripts (see file list)
- `aligned_sides/`: aligned images and their `_aligned_corners.txt` files (these are not outputs if you created them during the pipeline — they are considered inputs for stitching)
- `aligned_rectified_sides/`: rectified images and optional masks (input for masked stitching)
- `trimmed_sides/` or `out_trimmed_sides/`: trimmed images and their corner files (intermediate; keep organized)

Files of interest
-----------------
- `warp_align_sides.py` — aligns trimmed side images into a fixed-size canvas and writes `<idx>_aligned.jpg` and `<idx>_aligned_corners.txt`.
  - Key flags: `--center-container` to normalize horizontal container position across frames.
- `test3_sides.py` — incremental mosaic stitcher that builds a panorama from `*_aligned.jpg` inputs.
  - Key flags: `--transform {translation,affine,homography}` choose geometric model.
  - `--blend {feather,seam,none}` choose blending mode (seam uses a minimal-error vertical cut; seam-width added for soft blending).
  - `--lock-dy` force vertical translation to zero across frames to avoid vertical drift.

How to run (typical full-side pipeline)
---------------------------------------
1. Detect corners for raw side images (from using yolo to detect corner bounding boxes to using those boxes to find the exact corners):

   python3 test3_sides.py --aligned-dir ... --corners-dir ... --detector kaze --lock-dy --blend seam --seam-width 5 --stride 2 --out ...

2. (Optional) Trim black borders and update corner files:

   python3 trim_black_sides_update_corners.py --dir raw_images --corners corners_dir --out out_trimmed_sides --corners-out out_trimmed_sides_corners

3. Align trimmed images to a common canvas:

   python3 warp_align_sides.py --dir out_trimmed_sides --indices 210-261 --corners-dir out_trimmed_sides_corners --out aligned_sides --center-container

4. Rectify to rectangles and write masks:

   python3 rectify_to_rectangle_sides.py --dir aligned_sides --indices 210-261 --corners-suffix _aligned_corners.txt --out aligned_rectified_sides --write-mask

5. Stitch into a panorama (recommended: translation + seam):

   python3 test3_sides.py --aligned-dir aligned_sides --indices 210-261 --corners-dir aligned_sides --corners-suffix _aligned_corners.txt --stride 1 --transform translation --blend seam --lock-dy --seam-width 5 --out out_panorama

Notes & troubleshooting
-----------------------
- If panorama curves (global bend): prefer `--transform translation` instead of affine/homography, or use `--center-container` when aligning.
- If seams look sharp or "cut" (visible breaks): increase `--seam-width` (5-12) to soften the seam into a band.
- If image drifts vertically across frames: use `--lock-dy` to force zero vertical translation, or post-process dy drift removal.
- If features are sparse and matching fails: try ECC fallback (automatic), or generate masks and use `--transform affine` on rectified frames.

Developer notes
---------------
- Code contains side-specific copies (suffix `_sides.py`) to avoid changing top-face logic.
- Outputs (folders starting with `out_` or `out*`) are not documented above per request — they are generated by runs and kept as artifacts.

